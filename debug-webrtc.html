<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .video-container { display: flex; gap: 20px; margin: 20px 0; }
        video { width: 300px; height: 200px; border: 2px solid #ccc; }
        .logs { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>WebRTC Connection Test</h1>
    
    <div>
        <button onclick="startLocalVideo()">Start Local Video</button>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div class="video-container">
        <div>
            <h3>Local Video</h3>
            <video id="localVideo" autoplay muted></video>
        </div>
        <div>
            <h3>Remote Video</h3>
            <video id="remoteVideo" autoplay></video>
        </div>
    </div>
    
    <div>
        <h3>Debug Logs</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAVEVJS5si6tXjd8-impxmq_jQMn9Qe15s",
            authDomain: "cosmivity-d789f.firebaseapp.com",
            projectId: "cosmivity-d789f",
            storageBucket: "cosmivity-d789f.firebasestorage.app",
            messagingSenderId: "822858074367",
            appId: "1:822858074367:web:ca5de8953cd50dcccde4ca"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let localStream = null;
        const roomId = 'OtaUCMN7CjnGMYZh4MeZ';
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        window.startLocalVideo = async function() {
            try {
                log('🎥 Requesting user media...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                log(`✅ Local stream obtained with ${localStream.getTracks().length} tracks`);
                localStream.getTracks().forEach(track => {
                    log(`  - ${track.kind} track: ${track.enabled ? 'enabled' : 'disabled'}`);
                });
            } catch (error) {
                log(`❌ Error getting user media: ${error.message}`);
            }
        };
        
        window.testFirebaseConnection = async function() {
            try {
                log('🔥 Testing Firebase connection...');
                const participantsRef = collection(db, 'rooms', roomId, 'participants');
                
                // Listen for participants
                const unsubscribe = onSnapshot(participantsRef, (snapshot) => {
                    log(`👥 Participants snapshot: ${snapshot.size} documents`);
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        log(`  - Participant: ${data.name} (${doc.id})`);
                    });
                });
                
                // Add a test participant
                await addDoc(participantsRef, {
                    uid: 'test-user-' + Date.now(),
                    name: 'Test User',
                    avatarUrl: '',
                    isMuted: false,
                    isCameraOn: true,
                    isSharingScreen: false,
                    joinedAt: serverTimestamp()
                });
                
                log('✅ Test participant added to Firebase');
                
                // Clean up after 5 seconds
                setTimeout(() => {
                    unsubscribe();
                    log('🧹 Cleaned up Firebase listener');
                }, 5000);
                
            } catch (error) {
                log(`❌ Firebase error: ${error.message}`);
            }
        };
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        };
        
        // Auto-start local video
        window.addEventListener('load', () => {
            log('🚀 Debug page loaded');
            startLocalVideo();
        });
    </script>
</body>
</html>
